From 531b9785c4691fd1cedf4fd3de1856e9c2d58e47 Mon Sep 17 00:00:00 2001
From: yousour <hengyousour@gmail.com>
Date: Wed, 9 Dec 2015 08:09:44 +0700
Subject: [PATCH] save&print

---
 dental/client/app/subscriptions/subscriptions.js   |  45 +--
 dental/client/css/custom.css                       |   5 +
 dental/client/templates/payment/payment.html       |   3 +
 dental/client/templates/payment/payment.js         |  17 ++
 .../client/templates/reports/specialInvoice.html   |   2 +-
 .../client/templates/reports/specialTreatment.html |  81 +++++
 .../client/templates/reports/specialTreatment.js   |  15 +
 .../reports/specialTreatmentDescription.html       |  19 ++
 .../reports/specialTreatmentDescription.js         |  18 ++
 dental/client/templates/reports/treatment.html     |   2 +-
 .../templates/reports/treatmentDescription.html    |   8 +-
 .../templates/reports/treatmentDescription.js      |   3 +-
 .../templates/specialPayment/specialPayment.html   |   1 +
 .../templates/specialPayment/specialPayment.js     |  20 +-
 .../templates/specialRegister/specialRegister.html |   8 +-
 .../templates/specialRegister/specialRegister.js   |  16 +-
 .../specialTreatment/specialTreatment.html         | 137 +++++++++
 .../templates/specialTreatment/specialTreatment.js | 170 +++++++++++
 .../specialTreatment/specialTreatmentInfo.html     |  18 ++
 .../specialTreatment/specialTreatmentInfo.js       |  10 +
 dental/client/templates/treatment/treatment.html   |  81 ++---
 dental/client/templates/treatment/treatment.js     |  75 ++---
 dental/common/collections/specialTreatment.js      |  92 ++++++
 dental/common/collections/treatment.js             |  23 +-
 dental/common/routers/reports/specialTreatment.js  |  38 +++
 .../common/routers/specialTreatmentDescription.js  |  22 ++
 dental/common/tabulars/payment.js                  |   1 +
 dental/common/tabulars/specialRegister.js          |   9 +-
 dental/common/tabulars/specialTreatment.js         |  51 ++++
 dental/common/tabulars/treatment.js                |   7 +-
 dental/server/collectionsCache/specialRegister.js  |   2 +-
 dental/server/collectionsCache/specialTreatment.js |  14 +
 dental/server/collectionsHook/specialPayment.js    |   3 +-
 .../methods/reports/specialPaymentInvoice.js       |   6 +
 dental/server/methods/reports/specialTreatment.js  |  45 +++
 .../methods/reports/specialTreatmentDescription.js |  46 +++
 .../server/methods/reports/treatmentDescription.js |   7 +-
 dental/server/publications/publications.js         | 337 +++++++++++----------
 dental/server/security/security.js                 |  15 +
 39 files changed, 1157 insertions(+), 315 deletions(-)
 create mode 100644 dental/client/templates/reports/specialTreatment.html
 create mode 100644 dental/client/templates/reports/specialTreatment.js
 create mode 100644 dental/client/templates/reports/specialTreatmentDescription.html
 create mode 100644 dental/client/templates/reports/specialTreatmentDescription.js
 create mode 100644 dental/client/templates/specialTreatment/specialTreatment.html
 create mode 100644 dental/client/templates/specialTreatment/specialTreatment.js
 create mode 100644 dental/client/templates/specialTreatment/specialTreatmentInfo.html
 create mode 100644 dental/client/templates/specialTreatment/specialTreatmentInfo.js
 create mode 100644 dental/common/collections/specialTreatment.js
 create mode 100644 dental/common/routers/reports/specialTreatment.js
 create mode 100644 dental/common/routers/specialTreatmentDescription.js
 create mode 100644 dental/common/tabulars/specialTreatment.js
 create mode 100644 dental/server/collectionsCache/specialTreatment.js
 create mode 100644 dental/server/methods/reports/specialPaymentInvoice.js
 create mode 100644 dental/server/methods/reports/specialTreatment.js
 create mode 100644 dental/server/methods/reports/specialTreatmentDescription.js

diff --git a/dental/client/app/subscriptions/subscriptions.js b/dental/client/app/subscriptions/subscriptions.js
index 1706c09..fdf30d1 100644
--- a/dental/client/app/subscriptions/subscriptions.js
+++ b/dental/client/app/subscriptions/subscriptions.js
@@ -1,22 +1,23 @@
-Meteor.subscribe('dental_staff');
-Meteor.subscribe('dental_doctor');
-Meteor.subscribe('dental_diseaseCategory');
-Meteor.subscribe('dental_diseaseItem');
-Meteor.subscribe('dental_patient');
-Meteor.subscribe('dental_supplier');
-Meteor.subscribe('dental_laboratory');
-Meteor.subscribe('dental_materialCost');
-Meteor.subscribe('dental_materialCostCategory');
-Meteor.subscribe('dental_materialCostItem');
-Meteor.subscribe('dental_orderCategory');
-Meteor.subscribe('dental_orderItem');
-Meteor.subscribe('dental_patientHistory');
-Meteor.subscribe('dental_register');
-Meteor.subscribe('dental_specialRegister');
-Meteor.subscribe('dental_treatment');
-Meteor.subscribe('dental_deposit');
-Meteor.subscribe('dental_invoice');
-Meteor.subscribe('dental_purchase');
-Meteor.subscribe('dental_payment');
-Meteor.subscribe('dental_specialPayment');
-Meteor.subscribe('dental_quotation');
+Meteor.subscribe('dental_staff');
+Meteor.subscribe('dental_doctor');
+Meteor.subscribe('dental_diseaseCategory');
+Meteor.subscribe('dental_diseaseItem');
+Meteor.subscribe('dental_patient');
+Meteor.subscribe('dental_supplier');
+Meteor.subscribe('dental_laboratory');
+Meteor.subscribe('dental_materialCost');
+Meteor.subscribe('dental_materialCostCategory');
+Meteor.subscribe('dental_materialCostItem');
+Meteor.subscribe('dental_orderCategory');
+Meteor.subscribe('dental_orderItem');
+Meteor.subscribe('dental_patientHistory');
+Meteor.subscribe('dental_register');
+Meteor.subscribe('dental_specialRegister');
+Meteor.subscribe('dental_treatment');
+Meteor.subscribe('dental_deposit');
+Meteor.subscribe('dental_invoice');
+Meteor.subscribe('dental_purchase');
+Meteor.subscribe('dental_payment');
+Meteor.subscribe('dental_specialPayment');
+Meteor.subscribe('dental_specialTreatment');
+Meteor.subscribe('dental_quotation');
diff --git a/dental/client/css/custom.css b/dental/client/css/custom.css
index 73c0e6c..729f2ce 100644
--- a/dental/client/css/custom.css
+++ b/dental/client/css/custom.css
@@ -212,6 +212,11 @@
   width: 125px;
 }
 
+/*custom style treatmentDescription*/
+.treatment-des-style{
+  text-align: left;
+}
+
 /*custom style doctor*/
 .doctor-style{
   width: 150px;
diff --git a/dental/client/templates/payment/payment.html b/dental/client/templates/payment/payment.html
index c9452ca..fb4ba78 100644
--- a/dental/client/templates/payment/payment.html
+++ b/dental/client/templates/payment/payment.html
@@ -20,6 +20,8 @@
         <li><a href="#" class="update">{{fa "pencil"}} Update</a></li>
         <li><a href="#" class="remove">{{fa "remove"}} Remove</a></li>
         <li><a href="#" class="show">{{fa "eye"}} Show</a></li>
+        <li role="separator" class="divider"></li>
+        <li><a style="cursor: pointer" class="paymentPrintAction">{{fa "print"}} Print</a></li>
     {{/tabularAction}}
 </template>
 
@@ -89,6 +91,7 @@
         </div>
 
         <button type="submit" class="btn btn-primary">{{fa "floppy-o"}} Save</button>
+        <button type="submit" class="btn btn-info" id="saveAndPrint">{{fa "floppy-o"}} Save & Print</button>
         <button type="button" class="btn btn-success btnFree">{{fa "star"}} Free</button>
         <button type="reset" class="btn btn-default">{{fa "refresh"}} Reset</button>
     {{/autoForm}}
diff --git a/dental/client/templates/payment/payment.js b/dental/client/templates/payment/payment.js
index 79988ce..ada3b3f 100644
--- a/dental/client/templates/payment/payment.js
+++ b/dental/client/templates/payment/payment.js
@@ -74,6 +74,11 @@ Template.dental_payment.events({
   'click .show': function() {
     alertify.alert(fa("eye", "Payment"), renderTemplate(Template.dental_paymentShow,
       this));
+  },
+  'click .paymentPrintAction': function() {
+    var q = 'patient=' + this.patientId + '&register=' + this.registerId;
+    var url = 'invoiceReportGen?' + q;
+    window.open(url);
   }
 });
 
@@ -91,6 +96,9 @@ Template.dental_paymentInsert.events({
   'keyup .paidAmount': function() {
     calculateBalance();
   },
+  'click #saveAndPrint': function() {
+    Session.set('printInvoicePayment', true);
+  },
   'click .btnFree': function(e, t) {
     $('.dueAmount, .paidAmount, .balance').val(0);
   }
@@ -139,6 +147,15 @@ AutoForm.hooks({
       if (Session.get('closePayment')) {
         alertify.payment().close();
       }
+
+      var printSession = Session.get('printInvoicePayment');
+      var data = Dental.Collection.Payment.findOne(result);
+      if (printSession) {
+        var q = 'patient=' + data.patientId + '&register=' + data.registerId;
+        var url = '/dental/invoiceReportGen?' + q;
+        window.open(url);
+      }
+      Session.set('printInvoicePayment', false);
       alertify.success('Success');
     },
     onError: function(formType, error) {
diff --git a/dental/client/templates/reports/specialInvoice.html b/dental/client/templates/reports/specialInvoice.html
index 60202fd..62ae6c8 100644
--- a/dental/client/templates/reports/specialInvoice.html
+++ b/dental/client/templates/reports/specialInvoice.html
@@ -13,7 +13,7 @@
           <br>
           <span class="report-company-name">{{title.company.enName}}</span>
           <br>
-          <u> វិក្កយបត្រ (Invoice)</u>
+          <u> វិក្កយបត្រ (Special Invoice)</u>
           <br>
         </div>
         <!-- {{title.company.khAddress}}, {{title.company.telephone}} -->
diff --git a/dental/client/templates/reports/specialTreatment.html b/dental/client/templates/reports/specialTreatment.html
new file mode 100644
index 0000000..20cae2c
--- /dev/null
+++ b/dental/client/templates/reports/specialTreatment.html
@@ -0,0 +1,81 @@
+<!--Generate-->
+<template name="dental_specialTreatmentReportGen">
+    {{#if data}}
+        {{#with data}}
+            <!--Title-->
+            <table class="report-title" style="width:719px;">
+                <tr>
+                    <td>
+                        <img src="/seng_ratha/logo.jpg">
+                    </td>
+                    <td>
+                      <div class="header-style">
+                      <span class="report-company-name"
+                            style="font-family: 'Khmer OS Muol">{{title.company.khName}}</span><br>
+                      <span class="report-company-name">{{title.company.enName}}</span><br>
+                      ព័ត៌មានលំអិត (Patient's Record)<br>
+                    </div>
+                    </td>
+                </tr>
+            </table>
+            <!--Header-->
+            <div style="width: 100%">
+                {{#with header}}
+                    <div style="width: 50%; padding-top: 12px; float: left;">
+                        <ul class="list-unstyled">
+                            <li><strong>Patient ID :</strong> {{patientId}}</li>
+                            <li><strong>Name :</strong> {{_patient.name}}</li>
+                            <li><strong>Gender :</strong> {{_patient.gender}}</li>
+                            <li><strong>Age :</strong> {{_patient.age}}</li>
+                        </ul>
+                    </div>
+                    <div style="width: 50%; padding-top: 12px; float: right;">
+                        <ul class="list-unstyled">
+                            <li><strong>Special Register ID :</strong> {{_id}}</li>
+                            <li><strong>Register Date :</strong> {{registerDate}}</li>
+                            <li><strong>Description :</strong> {{des}}</li>
+                        </ul>
+                    </div>
+                {{/with}}
+            </div>
+
+            <!--Content-->
+            <table class="report-content">
+                <thead class="report-content-header">
+                <tr>
+                    <th>N<sup>o</sup></th>
+                    <th>Treatment Date</th>
+                    <th>Description</th>
+                    <th>Doctor</th>
+                </tr>
+                </thead>
+
+                <tbody class="report-content-body">
+                {{#each content}}
+                    <tr class="td-custom">
+                        <td class="index-style">{{index}}</td>
+                        <td class="treatment-date-style">{{specialTreatmentDate}}</td>
+                        <td class="treatment-des-style">{{{des}}}</td>
+                        <td class="doctor-style">{{_doctor.name}}</td>
+                    </tr>
+                {{/each}}
+                </tbody>
+            </table>
+
+            <!--Sign-->
+            <div style="width: 100%; float: left; margin-top: 20px;">
+              <strong>Prepared By :</strong> __________________
+            </div>
+            <div style="width: 100%; float: right; margin-top: 20px; text-align:center;">
+                <strong>{{title.company.khAddress}}, {{title.company.telephone}}</strong>
+            </div>
+
+            <!--Note-->
+            <!-- <div style="clear: both; width: 100%; text-align: center; margin-top: 20px">
+              <strong>{{title.company.khAddress}}, {{title.company.telephone}}</strong>
+            </div> -->
+        {{/with}}
+    {{else}}
+        {{> loading}}
+    {{/if}}
+</template>
diff --git a/dental/client/templates/reports/specialTreatment.js b/dental/client/templates/reports/specialTreatment.js
new file mode 100644
index 0000000..65c4f04
--- /dev/null
+++ b/dental/client/templates/reports/specialTreatment.js
@@ -0,0 +1,15 @@
+Dental.ListForReportState = new ReactiveObj();
+/************ Generate *************/
+Template.dental_specialTreatmentReportGen.helpers({
+  data: function() {
+    var self = this;
+    var callId = JSON.stringify(self);
+    var call = Meteor.callAsync(callId, 'dental_specialTreatment', self);
+
+    if (!call.ready()) {
+      return false;
+    }
+
+    return call.result();
+  }
+});
diff --git a/dental/client/templates/reports/specialTreatmentDescription.html b/dental/client/templates/reports/specialTreatmentDescription.html
new file mode 100644
index 0000000..3d5d45f
--- /dev/null
+++ b/dental/client/templates/reports/specialTreatmentDescription.html
@@ -0,0 +1,19 @@
+<!--Show Description-->
+<template name="dental_specialTreatmentDescription">
+  <div class="page-header">
+  <h1>{{fa "paperclip"}} Attach File</h1>
+  <hr>
+  {{#if data}}
+  {{#with data}}
+      {{#each content}}
+        {{#each images}}
+        <p><img src="{{link}}"/></p>
+        {{/each}}
+      {{/each}}
+  {{/with}}
+  {{else}}
+  {{> loading}}
+  {{/if}}
+
+</div>
+</template>
diff --git a/dental/client/templates/reports/specialTreatmentDescription.js b/dental/client/templates/reports/specialTreatmentDescription.js
new file mode 100644
index 0000000..9dc3b47
--- /dev/null
+++ b/dental/client/templates/reports/specialTreatmentDescription.js
@@ -0,0 +1,18 @@
+Dental.ListForReportState = new ReactiveObj();
+
+/************ Generate **** *********/
+Template.dental_specialTreatmentDescription.helpers({
+  data: function() {
+    var self = this;
+    var callId = JSON.stringify(self);
+    var call = Meteor.callAsync(callId,
+      'dental_specialTreatmentDescription',
+      self);
+
+    if (!call.ready()) {
+      return false;
+    }
+
+    return call.result();
+  }
+});
diff --git a/dental/client/templates/reports/treatment.html b/dental/client/templates/reports/treatment.html
index 463a1be..277bfb7 100644
--- a/dental/client/templates/reports/treatment.html
+++ b/dental/client/templates/reports/treatment.html
@@ -73,7 +73,7 @@
                     <tr class="td-custom">
                         <td class="index-style">{{index}}</td>
                         <td class="treatment-date-style">{{treatmentDate}}</td>
-                        <td>{{{des}}}</td>
+                        <td class="treatment-des-style">{{{des}}}</td>
                         <td class="doctor-style">{{_doctor.name}}</td>
                     </tr>
                 {{/each}}
diff --git a/dental/client/templates/reports/treatmentDescription.html b/dental/client/templates/reports/treatmentDescription.html
index 922a754..23931e3 100644
--- a/dental/client/templates/reports/treatmentDescription.html
+++ b/dental/client/templates/reports/treatmentDescription.html
@@ -1,13 +1,15 @@
 <!--Show Description-->
 <template name="dental_treatmentDescription">
   <div class="page-header">
-  <h1>Description</h1>
+  <h1>{{fa "paperclip"}} Attach File</h1>
   <hr>
   {{#if data}}
   {{#with data}}
       {{#each content}}
-  <p>{{{des}}}</p>
-  {{/each}}
+        {{#each images}}
+        <p><img src="{{link}}"/></p>
+        {{/each}}
+      {{/each}}
   {{/with}}
   {{else}}
   {{> loading}}
diff --git a/dental/client/templates/reports/treatmentDescription.js b/dental/client/templates/reports/treatmentDescription.js
index 95a1f6e..e619c51 100644
--- a/dental/client/templates/reports/treatmentDescription.js
+++ b/dental/client/templates/reports/treatmentDescription.js
@@ -5,7 +5,8 @@ Template.dental_treatmentDescription.helpers({
   data: function() {
     var self = this;
     var callId = JSON.stringify(self);
-    var call = Meteor.callAsync(callId, 'dental_treatmentDescription',
+    var call = Meteor.callAsync(callId,
+      'dental_treatmentDescription',
       self);
 
     if (!call.ready()) {
diff --git a/dental/client/templates/specialPayment/specialPayment.html b/dental/client/templates/specialPayment/specialPayment.html
index 47187da..5d7d717 100644
--- a/dental/client/templates/specialPayment/specialPayment.html
+++ b/dental/client/templates/specialPayment/specialPayment.html
@@ -94,6 +94,7 @@
         </div>
 
         <button type="submit" class="btn btn-primary">{{fa "floppy-o"}} Save</button>
+        <button type="submit" class="btn btn-info" id="saveAndPrint">{{fa "floppy-o"}} Save & Print</button>
         <button type="reset" class="btn btn-default">{{fa "refresh"}} Reset</button>
     {{/autoForm}}
 </template>
diff --git a/dental/client/templates/specialPayment/specialPayment.js b/dental/client/templates/specialPayment/specialPayment.js
index 9f84f27..d08ebde 100644
--- a/dental/client/templates/specialPayment/specialPayment.js
+++ b/dental/client/templates/specialPayment/specialPayment.js
@@ -14,7 +14,6 @@ Template.dental_specialPayment.helpers({
   },
   selector: function() {
     var registerId = Dental.RegisterState.get('data')._id;
-
     return {
       specialRegisterId: registerId
     };
@@ -27,6 +26,7 @@ Template.dental_specialPayment.events({
     checkLastPayment(self);
   },
   'click .insert': function() {
+    Session.set('closeSpecialPayment', true);
     var data = Dental.RegisterState.get('data');
 
     // Check last balance
@@ -100,6 +100,9 @@ Template.dental_specialPaymentInsert.events({
   'click .staffAddon': function() {
     alertify.staffAddon(fa("plus", "Staff"), renderTemplate(Template.dental_staffInsert));
   },
+  'click #saveAndPrint': function() {
+    Session.set('printSpecialInvoicePayment', true);
+  },
   'change .paymentMethod': function(e) {
     var getAmount = $(e.currentTarget).val();
     var splitAmount = getAmount.split(" | ");
@@ -160,7 +163,20 @@ AutoForm.hooks({
       }
     },
     onSuccess: function(formType, result) {
-      alertify.payment().close();
+      if (Session.get('closeSpecialPayment')) {
+        alertify.payment().close();
+      }
+
+      Meteor.call('getSpecialPayment', result, function(err, result) {
+        var printSession = Session.get('printSpecialInvoicePayment');
+        if (printSession) {
+          var q = 'specialRegister=' + result;
+          var url = 'specialPaymentReportGen?' + q;
+          window.open(url);
+        }
+        Session.set('printSpecialInvoicePayment', false);
+      });
+
       alertify.success('Success');
     },
     onError: function(formType, error) {
diff --git a/dental/client/templates/specialRegister/specialRegister.html b/dental/client/templates/specialRegister/specialRegister.html
index 6a4f77a..d377bdb 100644
--- a/dental/client/templates/specialRegister/specialRegister.html
+++ b/dental/client/templates/specialRegister/specialRegister.html
@@ -24,7 +24,7 @@
 
 <!--Treatment-Link-Action-->
 <template name="dental_specialTreatmentLinkAction">
-    <button type="button" class="btn btn-default btn-sm treatmentAction">
+    <button type="button" class="btn btn-default btn-sm specialTreatmentAction">
         {{#if _treatmentCount}}
             {{_treatmentCount}}
         {{else}}
@@ -55,8 +55,8 @@
 <!--Print-->
 <template name="dental_specialRegisterPrintAction">
     {{#tabularAction icon="print"}}
-        <!--<li><a style="cursor: pointer" class="treatmentPrintAction">{{fa "medkit"}} Treatment</a></li>-->
-        <li><a style="cursor: pointer" class="specialInvoiceReportPrintAction">{{fa "money"}} Invoice</a></li>
+        <li><a style="cursor: pointer" class="specialTreatmentPrintAction">{{fa "medkit"}} Special Treatment</a></li>
+        <li><a style="cursor: pointer" class="specialInvoiceReportPrintAction">{{fa "money"}} Special Invoice</a></li>
     {{/tabularAction}}
 </template>
 
@@ -133,7 +133,7 @@
                     <button type="submit" class="btn btn-primary" id="saveAndPrint">{{fa "floppy-o"}} Save & Print</button>
                     <button type="reset" class="btn btn-default">{{fa "refresh"}} Reset</button>
                 </div>
-            </div>
+              </div>
 
         </div>
     {{/autoForm}}
diff --git a/dental/client/templates/specialRegister/specialRegister.js b/dental/client/templates/specialRegister/specialRegister.js
index 1c32215..fab53e5 100644
--- a/dental/client/templates/specialRegister/specialRegister.js
+++ b/dental/client/templates/specialRegister/specialRegister.js
@@ -17,7 +17,7 @@ Template.dental_specialRegister.onCreated(function() {
     'patientAddon',
     'doctorAddon',
     'statusAction',
-    'treatmentAction',
+    'specialTreatmentAction',
     'appointmentAction',
     'paymentAction'
   ]);
@@ -120,12 +120,12 @@ Template.dental_specialRegister.events({
       }
     }
   },
-  'click .treatmentAction': function() {
+  'click .specialTreatmentAction': function() {
     if (this.status == "Active") {
       registerState(this);
-      alertify.treatmentAction(
-        fa("medkit", "Treatment"),
-        renderTemplate(Template.dental_treatment)
+      alertify.specialTreatmentAction(
+        fa("medkit", "Special Treatment"),
+        renderTemplate(Template.dental_specialTreatment)
       ).maximize();
     }
   },
@@ -155,9 +155,9 @@ Template.dental_specialRegister.events({
     ).maximize();
   },
   // Print action
-  'click .treatmentPrintAction': function() {
-    var q = 'patient=' + this.patientId + '&register=' + this._id;
-    var url = 'treatmentReportGen?' + q;
+  'click .specialTreatmentPrintAction': function() {
+    var q = 'patient=' + this.patientId + '&specialRegister=' + this._id;
+    var url = 'specialTreatmentReportGen?' + q;
     window.open(url);
   },
   'click .specialInvoiceReportPrintAction': function() {
diff --git a/dental/client/templates/specialTreatment/specialTreatment.html b/dental/client/templates/specialTreatment/specialTreatment.html
new file mode 100644
index 0000000..913135c
--- /dev/null
+++ b/dental/client/templates/specialTreatment/specialTreatment.html
@@ -0,0 +1,137 @@
+<!--Index-->
+<template name="dental_specialTreatment">
+    <div class="row">
+        <div class="col-md-9">
+            <p style="margin-bottom: 10px">
+                <button type="button" class="btn btn-primary insert">{{fa "plus"}} Add New</button>
+            </p>
+            {{> tabular table=Dental.TabularTable.SpecialTreatment selector=selector class="table table-striped table-bordered table-condensed table-hover"}}
+        </div>
+        <div class="col-md-3">
+            {{> dental_specialRegisterInfo register}}
+        </div>
+    </div>
+</template>
+
+<!--Action-->
+<template name="dental_specialTreatmentAction">
+    {{#tabularAction}}
+        <li><a href="#" class="update">{{fa "pencil"}} Update</a></li>
+        <li><a href="#" class="remove">{{fa "remove"}} Remove</a></li>
+        <li><a href="#" class="show">{{fa "eye"}} Show</a></li>
+        <li role="separator" class="divider"></li>
+        <li><a style="cursor: pointer" class="specialTreatmentPrintAction">{{fa "print"}} Print</a></li>
+    {{/tabularAction}}
+</template>
+
+<!--Action-->
+<template name="dental_specialTreatmentDesAction">
+<button type="button" class="btn btn-sm btn-primary btn-block showDescription">{{fa "eye"}} Show</button>
+</template>
+
+<!--Insert-->
+<template name="dental_specialTreatmentInsert">
+    {{#autoForm collection=Dental.Collection.SpecialTreatment id="dental_specialTreatmentInsert" type="insert"}}
+        <div class="row">
+<div class="col-md-6">
+                {{> afQuickField name="specialTreatmentDate"}}
+</div>
+<div class="col-md-6">
+                <div class="form-group{{#if afFieldIsInvalid name='doctorId'}} has-error{{/if}}" data-required="true">
+                    <label class="control-label" for="doctorId">Doctor</label>
+
+                    <div class="input-group  select2-bootstrap-append">
+                        {{> afFieldInput name='doctorId'}}
+                        <span class="input-group-addon">
+                            <a href="#" class="doctorAddon">
+                                {{fa "plus"}}
+                            </a>
+                        </span>
+                    </div>
+                    {{#if afFieldIsInvalid name='doctorId'}}
+                        <span class="help-block">{{afFieldMessage name='doctorId'}}</span>
+                    {{/if}}
+                </div>
+</div>
+</div>
+<div class="row">
+<div class="col-md-6">
+
+    {{> afQuickField name="patientId" type="hidden" value=patientId}}
+    {{> afQuickField name="specialRegisterId"  type="hidden" value=_id}}
+                {{> afQuickField name="des" rows=3}}
+
+        </div>
+
+        <div class="col-md-6">
+              {{> afQuickField name="attachFile"}}
+        </div>
+</div>
+
+        <button type="submit" class="btn btn-primary">{{fa "floppy-o"}} Save</button>
+        <button type="submit" class="btn btn-primary" id="saveAndPrint">{{fa "floppy-o"}} Save & Print</button>
+        <button type="reset" class="btn btn-default">{{fa "refresh"}} Reset</button>
+    {{/autoForm}}
+</template>
+
+<!--Update-->
+<template name="dental_specialTreatmentUpdate">
+    {{#autoForm collection=Dental.Collection.SpecialTreatment doc=this id="dental_specialTreatmentUpdate" type="update"}}
+    <div class="row">
+  <div class="col-md-6">
+            {{> afQuickField name="specialTreatmentDate"}}
+  </div>
+  <div class="col-md-6">
+            <div class="form-group{{#if afFieldIsInvalid name='doctorId'}} has-error{{/if}}" data-required="true">
+                <label class="control-label" for="doctorId">Doctor</label>
+
+                <div class="input-group  select2-bootstrap-append">
+                    {{> afFieldInput name='doctorId'}}
+                    <span class="input-group-addon">
+                        <a href="#" class="doctorAddon">
+                            {{fa "plus"}}
+                        </a>
+                    </span>
+                </div>
+                {{#if afFieldIsInvalid name='doctorId'}}
+                    <span class="help-block">{{afFieldMessage name='doctorId'}}</span>
+                {{/if}}
+            </div>
+  </div>
+  </div>
+  <div class="row">
+  <div class="col-md-6">
+
+  {{> afQuickField name="patientId" }}
+  {{> afQuickField name="specialRegisterId"}}
+            {{> afQuickField name="des" rows=3}}
+
+    </div>
+
+    <div class="col-md-6">
+          {{> afQuickField name="attachFile"}}
+    </div>
+  </div>
+
+    <button type="submit" class="btn btn-primary">{{fa "floppy-o"}} Save</button>
+    <button type="reset" class="btn btn-default">{{fa "refresh"}} Reset</button>
+    {{/autoForm}}
+</template>
+
+<!--Show-->
+<template name="dental_specialTreatmentShow">
+    <dl class="dl-horizontal">
+        <dt>ID</dt>
+        <dd>{{_id}}</dd>
+        <dt>Special Treatment Date</dt>
+        <dd>{{specialTreatmentDate}}</dd>
+        <dt>Description</dt>
+        <dd>{{{des}}}</dd>
+        <dt>Doctor ID</dt>
+        <dd>{{doctorId}}</dd>
+        <dt>Doctor Name</dt>
+        <dd>{{_doctor.name}}</dd>
+        <!-- <dt>File</dt>
+        <dd>{{lightbox url=attachFileUrl title=_doctor.name icon="paperclip"}}</dd> -->
+    </dl>
+</template>
diff --git a/dental/client/templates/specialTreatment/specialTreatment.js b/dental/client/templates/specialTreatment/specialTreatment.js
new file mode 100644
index 0000000..395da7a
--- /dev/null
+++ b/dental/client/templates/specialTreatment/specialTreatment.js
@@ -0,0 +1,170 @@
+/*
+ * Index
+ */
+Template.dental_specialTreatment.onCreated(function() {
+  createNewAlertify(['specialTreatment', 'doctorAddon']);
+});
+
+Template.dental_specialTreatment.helpers({
+  register: function() {
+    return Dental.RegisterState.get('data');
+  },
+  selector: function() {
+    var specialRegisterId = Dental.RegisterState.get('data')._id;
+    return {
+      specialRegisterId: specialRegisterId
+    };
+  }
+});
+
+Template.dental_specialTreatment.events({
+  'click .insert': function() {
+    Session.set('closeTreatment', true);
+    var data = Dental.RegisterState.get('data');
+    alertify.specialTreatment(fa("plus", "Special Treatment"),
+      renderTemplate(Template.dental_specialTreatmentInsert,
+        data)).maximize();
+  },
+  'click .update': function() {
+    var data = Dental.Collection.SpecialTreatment.findOne({
+      _id: this._id
+    });
+
+    alertify.specialTreatment(fa("pencil", "Special Treatment"),
+      renderTemplate(Template
+        .dental_specialTreatmentUpdate, data)).maximize();
+  },
+  'click .remove': function() {
+    var self = this;
+
+    alertify.confirm(
+      fa("remove", "Special Treatment"),
+      "Are you sure to delete [" + self._id + "]?",
+      function() {
+        Dental.Collection.SpecialTreatment.remove(self._id, function(
+          error) {
+          if (error) {
+            alertify.error(error.message);
+          } else {
+            alertify.success("Success");
+          }
+        });
+      },
+      null
+    );
+  },
+  'click .show': function() {
+    var data = Dental.Collection.SpecialTreatment.findOne(this._id);
+    // data.attachFileUrl = null;
+    //
+    // if (!_.isUndefined(data.attachFile)) {
+    //   data.attachFileUrl = Files.findOne(data.attachFile).url();
+    // }
+    alertify.alert(fa("eye", "Special Treatment"), renderTemplate(
+      Template.dental_specialTreatmentShow,
+      data));
+  },
+  'click .showDescription': function() {
+    // Show Description
+    var q = 'specialTreatmentId=' + this._id;
+    var url = 'specialTreatmentDescriptionGen?' + q;
+    window.open(url);
+  },
+  'click .specialTreatmentPrintAction': function() {
+    var q = 'patient=' + this.patientId + '&specialRegister=' + this.specialRegisterId;
+    var url = 'specialTreatmentReportGen?' + q;
+    window.open(url);
+  }
+});
+
+/**
+ * Insert
+ */
+Template.dental_specialTreatmentInsert.onRendered(function() {
+  datepicker();
+});
+
+Template.dental_specialTreatmentInsert.events({
+  'click .doctorAddon': function(e, t) {
+    alertify.doctorAddon(
+      fa("plus", "Doctor"),
+      renderTemplate(Template.dental_doctorInsert)
+    );
+  },
+  'click #saveAndPrint': function(e, t) {
+    return Session.set('printInvoice', true);
+  }
+});
+
+/**
+ * Update
+ */
+Template.dental_specialTreatmentUpdate.onRendered(function() {
+  datepicker();
+});
+
+Template.dental_specialTreatmentUpdate.events({
+  'click .doctorAddon': function(e, t) {
+    alertify.doctorAddon(
+      fa("plus", "Doctor"),
+      renderTemplate(Template.dental_doctorInsert)
+    );
+  }
+});
+
+/**
+ * Hook
+ */
+AutoForm.hooks({
+  dental_specialTreatmentInsert: {
+    before: {
+      insert: function(doc) {
+        var currentBranch = Session.get('currentBranch');
+        doc._id = idGenerator.genWithPrefix(Dental.Collection.SpecialTreatment,
+          currentBranch + '-', 12);
+        doc.branchId = currentBranch;
+
+        return doc;
+      }
+    },
+    onSuccess: function(formType, result) {
+      if (Session.get('closeTreatment')) {
+        alertify.specialTreatment().close();
+      }
+      //clear select2
+      $('select').each(function() {
+        $(this).select2("val", "");
+      });
+
+      var printSession = Session.get('printInvoice');
+      var data = Dental.Collection.SpecialTreatment.findOne(result);
+      if (printSession) {
+        var q = 'patient=' + data.patientId + '&specialRegister=' + data.specialRegisterId;
+        var url = 'specialTreatmentReportGen?' + q;
+        window.open(url);
+      }
+      Session.set('printInvoice', false);
+      alertify.success("Success");
+    },
+    onError: function(formType, error) {
+      alertify.error(error.message);
+    }
+  },
+  dental_specialTreatmentUpdate: {
+    onSuccess: function(formType, result) {
+      alertify.specialTreatment().close();
+      alertify.success("Success");
+    },
+    onError: function(fromType, error) {
+      alertify.error(error.message);
+    }
+  }
+});
+
+/**
+ * Config date picker
+ */
+var datepicker = function() {
+  var treatmentDate = $('[name="treatmentDate"]');
+  DateTimePicker.dateTime(treatmentDate);
+};
diff --git a/dental/client/templates/specialTreatment/specialTreatmentInfo.html b/dental/client/templates/specialTreatment/specialTreatmentInfo.html
new file mode 100644
index 0000000..737130b
--- /dev/null
+++ b/dental/client/templates/specialTreatment/specialTreatmentInfo.html
@@ -0,0 +1,18 @@
+<!--Treatment Info-->
+<template name="dental_specialTreatmentInfo">
+    <div class="panel panel-default">
+        <div class="panel-heading">Special Treatment Info</div>
+        <div class="panel-body">
+            <ul class="list-unstyled">
+                {{#each data}}
+                    <li><strong>Date:</strong> {{specialTreatmentDate}}</li>
+                    <li><strong>Des:</strong> <a href="#" class="showDescription">View</a></li>
+                    <li style="border-bottom: 1px solid;">
+                        <li><strong>Doctor:</strong> {{_doctor.name}}</li>
+                        <!-- <strong>Attach File:</strong> {{lightbox url=attachFileUrl title=_doctor.name icon="paperclip"}} -->
+                    </li>
+                {{/each}}
+            </ul>
+        </div>
+    </div>
+</template>
diff --git a/dental/client/templates/specialTreatment/specialTreatmentInfo.js b/dental/client/templates/specialTreatment/specialTreatmentInfo.js
new file mode 100644
index 0000000..5cbea08
--- /dev/null
+++ b/dental/client/templates/specialTreatment/specialTreatmentInfo.js
@@ -0,0 +1,10 @@
+Template.dental_specialTreatmentInfo.helpers({
+  data: function() {
+    var self = this;
+    var getData = Dental.Collection.SpecialTreatment.find({
+      specialRegisterId: self.specialRegisterId
+    });
+
+    return getData;
+  }
+});
diff --git a/dental/client/templates/treatment/treatment.html b/dental/client/templates/treatment/treatment.html
index e083dee..cce2ea5 100644
--- a/dental/client/templates/treatment/treatment.html
+++ b/dental/client/templates/treatment/treatment.html
@@ -19,6 +19,8 @@
         <li><a href="#" class="update">{{fa "pencil"}} Update</a></li>
         <li><a href="#" class="remove">{{fa "remove"}} Remove</a></li>
         <li><a href="#" class="show">{{fa "eye"}} Show</a></li>
+        <li role="separator" class="divider"></li>
+        <li><a style="cursor: pointer" class="treatmentPrintAction">{{fa "print"}} Print</a></li>
     {{/tabularAction}}
 </template>
 
@@ -51,17 +53,23 @@
                     {{/if}}
                 </div>
 </div>
-<div class="col-md-12">
+</div>
+<div class="row">
+<div class="col-md-6">
 
     {{> afQuickField name="patientId" type="hidden" value=patientId}}
     {{> afQuickField name="registerId"  type="hidden" value=_id}}
                 {{> afQuickField name="des" rows=3}}
-                <!-- {{> afQuickField name="attachFile"}} -->
 
-            </div>
         </div>
 
+        <div class="col-md-6">
+              {{> afQuickField name="attachFile"}}
+        </div>
+</div>
+
         <button type="submit" class="btn btn-primary">{{fa "floppy-o"}} Save</button>
+        <button type="submit" class="btn btn-primary" id="saveAndPrint">{{fa "floppy-o"}} Save & Print</button>
         <button type="reset" class="btn btn-default">{{fa "refresh"}} Reset</button>
     {{/autoForm}}
 </template>
@@ -69,43 +77,44 @@
 <!--Update-->
 <template name="dental_treatmentUpdate">
     {{#autoForm collection=Dental.Collection.Treatment doc=this id="dental_treatmentUpdate" type="update"}}
-        <div class="row">
-            <div class="col-md-12">
-
-                {{> afQuickField name="patientId" type="hidden"}}
-                {{> afQuickField name="registerId"  type="hidden"}}
-
-                {{> afQuickField name="treatmentDate"}}
-
-                <!--</div>-->
-
-                <!--<div class="col-md-6">-->
-
-                <!--{{> afQuickField name="doctorId"}}-->
-                <div class="form-group{{#if afFieldIsInvalid name='doctorId'}} has-error{{/if}}" data-required="true">
-                    <label class="control-label" for="doctorId">Doctor</label>
-
-                    <div class="input-group  select2-bootstrap-append">
-                        {{> afFieldInput name='doctorId'}}
-                        <span class="input-group-addon">
-                            <a href="#" class="doctorAddon">
-                                {{fa "plus"}}
-                            </a>
-                        </span>
-                    </div>
-                    {{#if afFieldIsInvalid name='doctorId'}}
-                        <span class="help-block">{{afFieldMessage name='doctorId'}}</span>
-                    {{/if}}
+    <div class="row">
+<div class="col-md-6">
+            {{> afQuickField name="treatmentDate"}}
+</div>
+<div class="col-md-6">
+            <div class="form-group{{#if afFieldIsInvalid name='doctorId'}} has-error{{/if}}" data-required="true">
+                <label class="control-label" for="doctorId">Doctor</label>
+
+                <div class="input-group  select2-bootstrap-append">
+                    {{> afFieldInput name='doctorId'}}
+                    <span class="input-group-addon">
+                        <a href="#" class="doctorAddon">
+                            {{fa "plus"}}
+                        </a>
+                    </span>
                 </div>
+                {{#if afFieldIsInvalid name='doctorId'}}
+                    <span class="help-block">{{afFieldMessage name='doctorId'}}</span>
+                {{/if}}
+            </div>
+</div>
+</div>
+<div class="row">
+<div class="col-md-6">
 
-                {{> afQuickField name="des" rows=3}}
-                <!-- {{> afQuickField name="attachFile"}} -->
+{{> afQuickField type='hidden' name="patientId"}}
+{{> afQuickField type='hidden' name="registerId"}}
+            {{> afQuickField name="des" rows=3}}
 
-            </div>
-        </div>
+    </div>
 
-        <button type="submit" class="btn btn-primary">{{fa "floppy-o"}} Save</button>
-        <button type="reset" class="btn btn-default">{{fa "refresh"}} Reset</button>
+    <div class="col-md-6">
+          {{> afQuickField name="attachFile"}}
+    </div>
+</div>
+
+    <button type="submit" class="btn btn-primary">{{fa "floppy-o"}} Save</button>
+    <button type="reset" class="btn btn-default">{{fa "refresh"}} Reset</button>
     {{/autoForm}}
 </template>
 
diff --git a/dental/client/templates/treatment/treatment.js b/dental/client/templates/treatment/treatment.js
index 136b31b..ec91c1e 100644
--- a/dental/client/templates/treatment/treatment.js
+++ b/dental/client/templates/treatment/treatment.js
@@ -1,3 +1,4 @@
+Dental.ListState = new ReactiveObj();
 /*
  * Index
  */
@@ -11,7 +12,6 @@ Template.dental_treatment.helpers({
   },
   selector: function() {
     var registerId = Dental.RegisterState.get('data')._id;
-
     return {
       registerId: registerId
     };
@@ -65,6 +65,11 @@ Template.dental_treatment.events({
     var q = 'treatmentId=' + this._id;
     var url = 'treatmentDescriptionGen?' + q;
     window.open(url);
+  },
+  'click .treatmentPrintAction': function() {
+    var q = 'patient=' + this.patientId + '&register=' + this.registerId;
+    var url = 'treatmentReportGen?' + q;
+    window.open(url);
   }
 });
 
@@ -76,45 +81,14 @@ Template.dental_treatmentInsert.onRendered(function() {
 });
 
 Template.dental_treatmentInsert.events({
-  //'change [name="patientId"]': function (e, t) {
-  //    var patientId = t.$('[name="patientId"]').val();
-  //
-  //    // Set list state
-  //    Dental.ListState.set('patientId', patientId);
-  //},
-  //'change [name="registerId"]': function (e, t) {
-  //    var registerId = t.$('[name="registerId"]').val();
-  //    var treatmentDate = t.$('[name="treatmentDate"]');
-  //
-  //    // Set treatment date
-  //    if (!_.isEmpty(registerId)) {
-  //        var registerDoc = Dental.Collection.Register.findOne(registerId);
-  //        treatmentDate.data("DateTimePicker").minDate(registerDoc.registerDate);
-  //
-  //        // Check last treatment
-  //        var getLastTreatment = lastTreatment(registerId);
-  //        if (!_.isUndefined(getLastTreatment)) {
-  //            treatmentDate.data("DateTimePicker").minDate(getLastTreatment.treatmentDate);
-  //        }
-  //    }
-  //},
-  //'click .patientAddon': function (e, t) {
-  //    alertify.patientAddon(
-  //        fa("plus", "Patient"),
-  //        renderTemplate(Template.dental_patientInsert)
-  //    ).maximize();
-  //},
-  //'click .registerAddon': function (e, t) {
-  //    alertify.registerAddon(
-  //        fa("plus", "Register"),
-  //        renderTemplate(Template.dental_registerInsert)
-  //    ).maximize();
-  //},
   'click .doctorAddon': function(e, t) {
     alertify.doctorAddon(
       fa("plus", "Doctor"),
       renderTemplate(Template.dental_doctorInsert)
     );
+  },
+  'click #saveAndPrint': function(e, t) {
+    return Session.set('printInvoice', true);
   }
 });
 
@@ -126,28 +100,6 @@ Template.dental_treatmentUpdate.onRendered(function() {
 });
 
 Template.dental_treatmentUpdate.events({
-  //'change [name="patientId"]': function (e, t) {
-  //    var patientId = t.$('[name="patientId"]').val();
-  //
-  //    // Set list state
-  //    Dental.ListState.set('patientId', patientId);
-  //},
-  //'change [name="registerId"]': function (e, t) {
-  //    var registerId = t.$('[name="registerId"]').val();
-  //    var treatmentDate = t.$('[name="treatmentDate"]');
-  //
-  //    // Set treatment date
-  //    if (!_.isEmpty(registerId)) {
-  //        var registerDoc = Dental.Collection.Register.findOne(registerId);
-  //        treatmentDate.data("DateTimePicker").minDate(registerDoc.registerDate);
-  //
-  //        // Check last treatment
-  //        var getLastTreatment = lastTreatment(registerId);
-  //        if (!_.isUndefined(getLastTreatment)) {
-  //            treatmentDate.data("DateTimePicker").minDate(getLastTreatment.treatmentDate);
-  //        }
-  //    }
-  //}
   'click .doctorAddon': function(e, t) {
     alertify.doctorAddon(
       fa("plus", "Doctor"),
@@ -180,6 +132,15 @@ AutoForm.hooks({
         $(this).select2("val", "");
       });
 
+      var printSession = Session.get('printInvoice');
+      var data = Dental.Collection.Treatment.findOne(result);
+      if (printSession) {
+        var q = 'patient=' + data.patientId + '&register=' + data.registerId;
+        var url = 'treatmentReportGen?' + q;
+        window.open(url);
+      }
+      Session.set('printInvoice', false);
+
       alertify.success("Success");
     },
     onError: function(formType, error) {
diff --git a/dental/common/collections/specialTreatment.js b/dental/common/collections/specialTreatment.js
new file mode 100644
index 0000000..91eae54
--- /dev/null
+++ b/dental/common/collections/specialTreatment.js
@@ -0,0 +1,92 @@
+/**
+ *
+ * @type {Mongo.Collection}
+ */
+Dental.Collection.SpecialTreatment = new Mongo.Collection(
+  'dental_specialTreatment');
+
+/**
+ *
+ * @type {SimpleSchema}
+ */
+Dental.Schema.SpecialTreatment = new SimpleSchema({
+  patientId: {
+    type: String
+  },
+  specialRegisterId: {
+    type: String
+  },
+  specialTreatmentDate: {
+    type: String,
+    defaultValue: function() {
+      var currentDate = moment(ReactiveMethod.call("currentDate"),
+        'YYYY-MM-DD H:mm:ss').format('YYYY-MM-DD H:mm:ss');
+      return currentDate;
+    },
+    label: "Treatment Date"
+  },
+  doctorId: {
+    type: String,
+    autoform: {
+      type: "select2",
+      options: function() {
+        return Dental.List.doctor();
+      }
+    }
+  },
+  des: {
+    type: String,
+    label: "Description",
+    autoform: {
+      afFieldInput: {
+        type: 'summernote',
+        class: 'editor',
+        settings: {
+          height: 92,
+          toolbar: [
+            //[groupname, [button list]]
+            ['style', ['bold', 'italic', 'underline']],
+            ['font', ['strikethrough']],
+            ['fontsize', ['fontsize']],
+            ['color', ['color']],
+            ['para', ['ul', 'ol', 'paragraph']],
+            // ['insert', ['picture']],
+            ['misc', ['fullscreen']],
+          ]
+        }
+      }
+    }
+  },
+  attachFile: {
+    type: [String],
+    label: 'Choose file',
+    optional: true
+  },
+  "attachFile.$": {
+    autoform: {
+      afFieldInput: {
+        type: 'fileUpload',
+        collection: 'Files'
+      }
+    }
+  },
+  // attachFile: {
+  //   type: String,
+  //   label: 'Choose file',
+  //   autoform: {
+  //     afFieldInput: {
+  //       type: 'fileUpload',
+  //       collection: 'Files'
+  //     }
+  //   },
+  //   optional: true
+  // },
+  branchId: {
+    type: String
+  }
+});
+
+/**
+ * Attache schema
+ */
+Dental.Collection.SpecialTreatment.attachSchema(Dental.Schema.SpecialTreatment);
diff --git a/dental/common/collections/treatment.js b/dental/common/collections/treatment.js
index 74204ed..2bf5e8e 100644
--- a/dental/common/collections/treatment.js
+++ b/dental/common/collections/treatment.js
@@ -41,7 +41,7 @@ Dental.Schema.Treatment = new SimpleSchema({
         type: 'summernote',
         class: 'editor',
         settings: {
-          height: 340,
+          height: 92,
           toolbar: [
             //[groupname, [button list]]
             ['style', ['bold', 'italic', 'underline']],
@@ -49,7 +49,7 @@ Dental.Schema.Treatment = new SimpleSchema({
             ['fontsize', ['fontsize']],
             ['color', ['color']],
             ['para', ['ul', 'ol', 'paragraph']],
-            ['insert', ['picture']],
+            // ['insert', ['picture']],
             ['misc', ['fullscreen']],
           ]
         }
@@ -57,16 +57,29 @@ Dental.Schema.Treatment = new SimpleSchema({
     }
   },
   attachFile: {
-    type: String,
+    type: [String],
     label: 'Choose file',
+    optional: true
+  },
+  "attachFile.$": {
     autoform: {
       afFieldInput: {
         type: 'fileUpload',
         collection: 'Files'
       }
-    },
-    optional: true
+    }
   },
+  // attachFile: {
+  //   type: String,
+  //   label: 'Choose file',
+  //   autoform: {
+  //     afFieldInput: {
+  //       type: 'fileUpload',
+  //       collection: 'Files'
+  //     }
+  //   },
+  //   optional: true
+  // },
   branchId: {
     type: String
   }
diff --git a/dental/common/routers/reports/specialTreatment.js b/dental/common/routers/reports/specialTreatment.js
new file mode 100644
index 0000000..af3878c
--- /dev/null
+++ b/dental/common/routers/reports/specialTreatment.js
@@ -0,0 +1,38 @@
+Router.route('dental/specialTreatmentReport', function() {
+  this.render('dental_specialTreatmentReport');
+}, {
+  name: 'dental.specialTreatmentReport',
+  title: "Treatment List Report",
+  header: {
+    title: 'Treatment Report',
+    sub: '',
+    icon: 'file-text-o'
+  },
+  breadcrumb: {
+    title: 'Treatment Report',
+    parent: 'dental.home'
+  }
+});
+
+Router.route('dental/specialTreatmentReportGen', function() {
+  // Config layout
+  this.layout('reportLayout', {
+    // Page size: a4, a5, mini
+    // Orientation: portrait, landscape
+    // Font size: fontBody: undefined (10px), bg (12px)
+    data: {
+      pageSize: 'a4',
+      orientation: 'portrait',
+      fontBody: 'bg'
+    }
+  });
+
+  var q = this.params.query;
+  this.render('dental_specialTreatmentReportGen', {
+    data: function() {
+      return q;
+    }
+  });
+}, {
+  name: 'dental.specialTreatmentReportGen'
+});
diff --git a/dental/common/routers/specialTreatmentDescription.js b/dental/common/routers/specialTreatmentDescription.js
new file mode 100644
index 0000000..695d941
--- /dev/null
+++ b/dental/common/routers/specialTreatmentDescription.js
@@ -0,0 +1,22 @@
+Router.route('dental/specialTreatmentDescriptionGen', function() {
+  // Config layout
+  this.layout('reportLayout', {
+    // Page size: a4, a5, mini
+    // Orientation: portrait, landscape
+    // Font size: fontBody: undefined (10px), bg (12px)
+    data: {
+      pageSize: '',
+      orientation: 'portrait',
+      fontBody: 'bg'
+    }
+  });
+
+  var q = this.params.query;
+  this.render('dental_specialTreatmentDescription', {
+    data: function() {
+      return q;
+    }
+  });
+}, {
+  name: 'dental.specialTreatmentDescriptionGen'
+});
diff --git a/dental/common/tabulars/payment.js b/dental/common/tabulars/payment.js
index 8b96183..f502e76 100644
--- a/dental/common/tabulars/payment.js
+++ b/dental/common/tabulars/payment.js
@@ -38,6 +38,7 @@ Dental.TabularTable.Payment = new Tabular.Table({
   order: [
     ["1", "desc"]
   ],
+  extraFields: ['patientId'],
   autoWidth: false,
   columnDefs: [{
     "width": "12px",
diff --git a/dental/common/tabulars/specialRegister.js b/dental/common/tabulars/specialRegister.js
index 0dab9bf..50d9880 100644
--- a/dental/common/tabulars/specialRegister.js
+++ b/dental/common/tabulars/specialRegister.js
@@ -42,13 +42,12 @@ Dental.TabularTable.SpecialRegister = new Tabular.Table({
     }, {
       data: "status",
       title: "Status"
+    }, {
+      data: "_treatmentCount",
+      title: "T+",
+      tmpl: Meteor.isClient && Template.dental_specialTreatmentLinkAction
     },
     //{
-    //    data: "_treatmentCount",
-    //    title: "T+",
-    //    tmpl: Meteor.isClient && Template.dental_specialTreatmentLinkAction
-    //},
-    //{
     //    data: "_appointmentCount",
     //    title: "A+",
     //    tmpl: Meteor.isClient && Template.dental_specialAppointmentLinkAction
diff --git a/dental/common/tabulars/specialTreatment.js b/dental/common/tabulars/specialTreatment.js
new file mode 100644
index 0000000..8522fbf
--- /dev/null
+++ b/dental/common/tabulars/specialTreatment.js
@@ -0,0 +1,51 @@
+Dental.TabularTable.SpecialTreatment = new Tabular.Table({
+  name: "dentalSpecialTreatmentList",
+  collection: Dental.Collection.SpecialTreatment,
+  columns: [{
+      title: "<i class='fa fa-bars'></i>",
+      tmpl: Meteor.isClient && Template.dental_specialTreatmentAction
+    }, {
+      data: "specialTreatmentDate",
+      title: "Special Treatment Date"
+    }, {
+      data: "doctorId",
+      title: "Doctor ID"
+    }, {
+      data: "_doctor.name",
+      title: "Doctor Name"
+    }, {
+      data: "des",
+      title: "Description"
+    },
+    // {
+    //   data: "attachFile",
+    //   title: "<i class='fa fa-paperclip'></i>",
+    //   render: function(val, type, doc) {
+    //     //console.log(doc._doctor.name);
+    //     if (_.isUndefined(val)) {
+    //       return null;
+    //     } else {
+    //       var attacheFile = Files.findOne(val);
+    //       return lightbox(attacheFile.url(), doc._id, doc.doctorId,
+    //         'paperclip');
+    //     }
+    //   }
+    // },
+    {
+      title: "Attach File",
+      tmpl: Meteor.isClient && Template.dental_specialTreatmentDesAction
+    },
+  ],
+  order: [
+    ["1", "desc"]
+  ],
+  extraFields: ['patientId', 'specialRegisterId', 'des'],
+  autoWidth: false,
+  columnDefs: [{
+    "width": "12px",
+    "targets": 0
+  }, {
+    "width": "12px",
+    "targets": 4
+  }]
+});
diff --git a/dental/common/tabulars/treatment.js b/dental/common/tabulars/treatment.js
index 57e5251..55bc704 100644
--- a/dental/common/tabulars/treatment.js
+++ b/dental/common/tabulars/treatment.js
@@ -13,6 +13,9 @@ Dental.TabularTable.Treatment = new Tabular.Table({
     }, {
       data: "_doctor.name",
       title: "Doctor Name"
+    }, {
+      data: "des",
+      title: "Description"
     },
     // {
     //   data: "attachFile",
@@ -29,14 +32,14 @@ Dental.TabularTable.Treatment = new Tabular.Table({
     //   }
     // },
     {
-      title: "Description",
+      title: "Attach File",
       tmpl: Meteor.isClient && Template.dental_treatmentDesAction
     },
   ],
   order: [
     ["1", "desc"]
   ],
-  extraFields: ['des'],
+  extraFields: ['patientId', 'registerId', 'des'],
   autoWidth: false,
   columnDefs: [{
     "width": "12px",
diff --git a/dental/server/collectionsCache/specialRegister.js b/dental/server/collectionsCache/specialRegister.js
index 290fd38..6e3707b 100644
--- a/dental/server/collectionsCache/specialRegister.js
+++ b/dental/server/collectionsCache/specialRegister.js
@@ -14,7 +14,7 @@ Dental.Collection.SpecialRegister.cacheDoc(
 );
 
 Dental.Collection.SpecialRegister.cacheCount('treatmentCount', Dental.Collection
-  .Treatment, 'specialRegisterId');
+  .SpecialTreatment, 'specialRegisterId');
 Dental.Collection.SpecialRegister.cacheCount('appointmentCount', Dental.Collection
   .CalendarEvent, 'specialRegisterId');
 Dental.Collection.SpecialRegister.cacheCount('paymentCount', Dental.Collection.SpecialPayment,
diff --git a/dental/server/collectionsCache/specialTreatment.js b/dental/server/collectionsCache/specialTreatment.js
new file mode 100644
index 0000000..76cc71e
--- /dev/null
+++ b/dental/server/collectionsCache/specialTreatment.js
@@ -0,0 +1,14 @@
+// Collection
+Dental.Collection.SpecialTreatment.cacheDoc(
+  'specialRegister',
+  Dental.Collection.SpecialRegister, ['registerDate', 'des', 'patientId',
+    '_patient'
+  ]
+);
+
+Dental.Collection.SpecialTreatment.cacheDoc(
+  'doctor',
+  Dental.Collection.Doctor, ['name', 'gender', 'address', 'startDate',
+    'telephone', 'photo'
+  ]
+);
diff --git a/dental/server/collectionsHook/specialPayment.js b/dental/server/collectionsHook/specialPayment.js
index cba24dc..30214bd 100644
--- a/dental/server/collectionsHook/specialPayment.js
+++ b/dental/server/collectionsHook/specialPayment.js
@@ -4,9 +4,11 @@ Dental.Collection.SpecialPayment.before.insert(function(userId, doc) {
   }
 
   //generate Id
+  var id = doc._id;
   var branchPre = doc._id;
   doc._id = idGenerator.genWithPrefix(Dental.Collection.SpecialPayment,
     branchPre, 3);
+  Dental.ListState.set(id, doc.specialRegisterId);
 });
 Dental.Collection.SpecialPayment.after.insert(function(userId, doc) {
   Meteor.defer(function() {
@@ -37,7 +39,6 @@ Dental.Collection.SpecialPayment.after.remove(function(userId, doc) {
 
 });
 
-
 var updateSpecialRegister = function(doc) {
   if (doc.paymentMethod == doc._specialRegister.paymentMethod.length) {
     Dental.Collection.SpecialRegister.direct.update({
diff --git a/dental/server/methods/reports/specialPaymentInvoice.js b/dental/server/methods/reports/specialPaymentInvoice.js
new file mode 100644
index 0000000..d5b91c5
--- /dev/null
+++ b/dental/server/methods/reports/specialPaymentInvoice.js
@@ -0,0 +1,6 @@
+Meteor.methods({
+  getSpecialPayment: function(id) {
+    var specialPaymentId = Dental.ListState.get(id);
+    return specialPaymentId;
+  }
+});
diff --git a/dental/server/methods/reports/specialTreatment.js b/dental/server/methods/reports/specialTreatment.js
new file mode 100644
index 0000000..21aa7e8
--- /dev/null
+++ b/dental/server/methods/reports/specialTreatment.js
@@ -0,0 +1,45 @@
+Meteor.methods({
+  dental_specialTreatment: function(params) {
+    var self = params;
+    var data = {
+      title: {},
+      header: {},
+      content: []
+    };
+
+    /********* Title *********/
+    var company = Cpanel.Collection.Company.findOne();
+    data.title = {
+      company: company
+    };
+
+    /********* Header ********/
+    var registerDoc = Dental.Collection.SpecialRegister.findOne(self.specialRegister);
+    data.header = registerDoc;
+
+    /********** Content & Footer **********/
+    var content = [];
+
+    // Get invoice
+    var index = 1;
+    Dental.Collection.SpecialTreatment.find({
+        specialRegisterId: self.specialRegister
+      })
+      .forEach(function(obj) {
+        obj.index = index;
+        content.push(obj);
+
+        index += 1;
+      });
+
+    if (content.length > 0) {
+      data.content = content;
+      return data;
+    } else {
+      data.content.push({
+        index: 'no results'
+      });
+      return data;
+    }
+  }
+});
diff --git a/dental/server/methods/reports/specialTreatmentDescription.js b/dental/server/methods/reports/specialTreatmentDescription.js
new file mode 100644
index 0000000..8092339
--- /dev/null
+++ b/dental/server/methods/reports/specialTreatmentDescription.js
@@ -0,0 +1,46 @@
+Meteor.methods({
+  dental_specialTreatmentDescription: function(params) {
+    var self = params;
+    var data = {
+      title: {},
+      header: {},
+      content: []
+    };
+
+    /********* Title *********/
+    // var company = Cpanel.Collection.Company.findOne();
+    // data.title = {
+    //   company: company
+    // };
+
+    /********* Header ********/
+    // var registerDoc = Dental.Collection.Register.findOne(self.register);
+    // data.header = registerDoc;
+
+    /********** Content & Footer **********/
+    var content = [];
+    // Get special treament
+    Dental.Collection.SpecialTreatment.find({
+        _id: self.specialTreatmentId
+      })
+      .forEach(function(obj) {
+        obj.images = [];
+        obj.attachFile.forEach(function(id) {
+          obj.images.push({
+            link: Files.findOne(id).url()
+          });
+        });
+        content.push(obj);
+      });
+
+    if (content.length > 0) {
+      data.content = content;
+      return data;
+    } else {
+      data.content.push({
+        index: 'no results'
+      });
+      return data;
+    }
+  }
+});
diff --git a/dental/server/methods/reports/treatmentDescription.js b/dental/server/methods/reports/treatmentDescription.js
index 91475a6..73830d3 100644
--- a/dental/server/methods/reports/treatmentDescription.js
+++ b/dental/server/methods/reports/treatmentDescription.js
@@ -19,12 +19,17 @@ Meteor.methods({
 
     /********** Content & Footer **********/
     var content = [];
-
     // Get treament
     Dental.Collection.Treatment.find({
         _id: self.treatmentId
       })
       .forEach(function(obj) {
+        obj.images = [];
+        obj.attachFile.forEach(function(id) {
+          obj.images.push({
+            link: Files.findOne(id).url()
+          });
+        });
         content.push(obj);
       });
 
diff --git a/dental/server/publications/publications.js b/dental/server/publications/publications.js
index 9e42264..4eebd45 100644
--- a/dental/server/publications/publications.js
+++ b/dental/server/publications/publications.js
@@ -1,165 +1,172 @@
-/**
- * Staff
- */
-Meteor.publish('dental_staff', function () {
-    if (this.userId) {
-        return Dental.Collection.Staff.find();
-    }
-});
-
-/**
- * Doctor
- */
-Meteor.publish('dental_doctor', function () {
-    if (this.userId) {
-        return Dental.Collection.Doctor.find();
-    }
-});
-
-/**
- * Disease Category
- */
-Meteor.publish('dental_diseaseCategory', function () {
-    if (this.userId) {
-        return Dental.Collection.DiseaseCategory.find();
-    }
-});
-
-/**
- * Disease Item
- */
-Meteor.publish('dental_diseaseItem', function () {
-    if (this.userId) {
-        return Dental.Collection.DiseaseItem.find();
-    }
-});
-
-/*
- * Patient History
- */
-Meteor.publish('dental_patientHistory', function () {
-    if (this.userId) {
-        return Dental.Collection.PatientHistory.find();
-    }
-});
-
-/**
- * Patient
- */
-Meteor.publish('dental_patient', function () {
-    if (this.userId) {
-        return Dental.Collection.Patient.find();
-    }
-});
-
-/*
- * Laboratory
- */
-Meteor.publish('dental_laboratory', function () {
-    return Dental.Collection.Laboratory.find();
-});
-
-/*
- * Material Cost
- */
-Meteor.publish('dental_materialCost', function () {
-    return Dental.Collection.MaterialCost.find();
-});
-
-/*
- * Material Cost Category
- */
-Meteor.publish('dental_materialCostCategory', function () {
-    return Dental.Collection.MaterialCostCategory.find();
-});
-
-/*
- * Material Cost Item
- */
-Meteor.publish('dental_materialCostItem', function () {
-    return Dental.Collection.MaterialCostItem.find();
-});
-
-/*
- *Supplier
- */
-Meteor.publish('dental_supplier', function () {
-    return Dental.Collection.Supplier.find();
-});
-
-/*
- * Order Category
- */
-Meteor.publish('dental_orderCategory', function () {
-    return Dental.Collection.OrderCategory.find();
-});
-
-/*
- *Order Item
- */
-Meteor.publish('dental_orderItem', function () {
-    return Dental.Collection.OrderItem.find();
-});
-
-/*
- *Register
- */
-Meteor.publish('dental_register', function () {
-    return Dental.Collection.Register.find();
-});
-
-/*
- *Special Register
- */
-Meteor.publish('dental_specialRegister', function () {
-    return Dental.Collection.SpecialRegister.find();
-});
-
-/*
- * Treatment
- */
-Meteor.publish('dental_treatment', function () {
-    return Dental.Collection.Treatment.find();
-});
-
-/*
- * Deposit
- */
-Meteor.publish('dental_deposit', function () {
-    return Dental.Collection.Deposit.find();
-});
-
-/*
- * Invoice
- */
-Meteor.publish('dental_invoice', function () {
-    return Dental.Collection.Invoice.find();
-});
-
-/*
- * Purchase
- */
-Meteor.publish('dental_purchase', function () {
-    return Dental.Collection.Purchase.find();
-});
-
-/*
- * Payment
- */
-Meteor.publish('dental_payment',function(){
-   return Dental.Collection.Payment.find();
-});
-
-/*
- *Special Payment
- */
-Meteor.publish('dental_specialPayment',function(){
-    return Dental.Collection.SpecialPayment.find();
-});
-
-/*
- * Quotation
- */
-Meteor.publish('dental_quotation',function(){
-    return Dental.Collection.Quotation.find();
-});
\ No newline at end of file
+/**
+ * Staff
+ */
+Meteor.publish('dental_staff', function() {
+  if (this.userId) {
+    return Dental.Collection.Staff.find();
+  }
+});
+
+/**
+ * Doctor
+ */
+Meteor.publish('dental_doctor', function() {
+  if (this.userId) {
+    return Dental.Collection.Doctor.find();
+  }
+});
+
+/**
+ * Disease Category
+ */
+Meteor.publish('dental_diseaseCategory', function() {
+  if (this.userId) {
+    return Dental.Collection.DiseaseCategory.find();
+  }
+});
+
+/**
+ * Disease Item
+ */
+Meteor.publish('dental_diseaseItem', function() {
+  if (this.userId) {
+    return Dental.Collection.DiseaseItem.find();
+  }
+});
+
+/*
+ * Patient History
+ */
+Meteor.publish('dental_patientHistory', function() {
+  if (this.userId) {
+    return Dental.Collection.PatientHistory.find();
+  }
+});
+
+/**
+ * Patient
+ */
+Meteor.publish('dental_patient', function() {
+  if (this.userId) {
+    return Dental.Collection.Patient.find();
+  }
+});
+
+/*
+ * Laboratory
+ */
+Meteor.publish('dental_laboratory', function() {
+  return Dental.Collection.Laboratory.find();
+});
+
+/*
+ * Material Cost
+ */
+Meteor.publish('dental_materialCost', function() {
+  return Dental.Collection.MaterialCost.find();
+});
+
+/*
+ * Material Cost Category
+ */
+Meteor.publish('dental_materialCostCategory', function() {
+  return Dental.Collection.MaterialCostCategory.find();
+});
+
+/*
+ * Material Cost Item
+ */
+Meteor.publish('dental_materialCostItem', function() {
+  return Dental.Collection.MaterialCostItem.find();
+});
+
+/*
+ *Supplier
+ */
+Meteor.publish('dental_supplier', function() {
+  return Dental.Collection.Supplier.find();
+});
+
+/*
+ * Order Category
+ */
+Meteor.publish('dental_orderCategory', function() {
+  return Dental.Collection.OrderCategory.find();
+});
+
+/*
+ *Order Item
+ */
+Meteor.publish('dental_orderItem', function() {
+  return Dental.Collection.OrderItem.find();
+});
+
+/*
+ *Register
+ */
+Meteor.publish('dental_register', function() {
+  return Dental.Collection.Register.find();
+});
+
+/*
+ *Special Register
+ */
+Meteor.publish('dental_specialRegister', function() {
+  return Dental.Collection.SpecialRegister.find();
+});
+
+/*
+ * Treatment
+ */
+Meteor.publish('dental_treatment', function() {
+  return Dental.Collection.Treatment.find();
+});
+
+/*
+ * Deposit
+ */
+Meteor.publish('dental_deposit', function() {
+  return Dental.Collection.Deposit.find();
+});
+
+/*
+ * Invoice
+ */
+Meteor.publish('dental_invoice', function() {
+  return Dental.Collection.Invoice.find();
+});
+
+/*
+ * Purchase
+ */
+Meteor.publish('dental_purchase', function() {
+  return Dental.Collection.Purchase.find();
+});
+
+/*
+ * Payment
+ */
+Meteor.publish('dental_payment', function() {
+  return Dental.Collection.Payment.find();
+});
+
+/*
+ *Special Treatment
+ */
+Meteor.publish('dental_specialTreatment', function() {
+  return Dental.Collection.SpecialTreatment.find();
+});
+
+/*
+ *Special Payment
+ */
+Meteor.publish('dental_specialPayment', function() {
+  return Dental.Collection.SpecialPayment.find();
+});
+
+/*
+ * Quotation
+ */
+Meteor.publish('dental_quotation', function() {
+  return Dental.Collection.Quotation.find();
+});
diff --git a/dental/server/security/security.js b/dental/server/security/security.js
index 55983d7..b85bcbd 100644
--- a/dental/server/security/security.js
+++ b/dental/server/security/security.js
@@ -210,6 +210,21 @@ Dental.Collection.Payment.permit(['remove'])
   .apply();
 
 /*
+ *Special Treatment
+ */
+Dental.Collection.SpecialTreatment.permit(['insert'])
+  .dental_ifDataInsert()
+  .apply();
+
+Dental.Collection.SpecialTreatment.permit(['update'])
+  .dental_ifDataUpdate()
+  .apply();
+
+Dental.Collection.SpecialTreatment.permit(['remove'])
+  .dental_ifDataRemove()
+  .apply();
+
+/*
  *Special Payment
  */
 Dental.Collection.SpecialPayment.permit(['insert'])
-- 
1.9.1

